{"title":"week-06-assignment1-reflection-and-documentation","html":"<h1>Week 6 - Assignment 1 Reflection &#x26; Documentation</h1>\n<h2>Documentation</h2>\n<h3>Setting up the the Heart Rate Monitor</h3>\n<p><img src=\"/hb-sensor.jpg\" alt=\"heartbeat\">\n<em>Source: Jaycar</em></p>\n<p>The MAX3010x sensor has a good library from SparkFun available which includes\nexamples. I first got the sensor connected to Arduino according to the instruction\ngiven in the example file. This was relatively painless. It took a while to figure\nout how to position the sensor in order to get a good reading. Other than that\nthis is a relatively simple process.</p>\n<p>Library: <a href=\"https://github.com/sparkfun/SparkFun_MAX3010x_Sensor_Library\">SparkFun MAX3010x Sensor Library</a></p>\n<h3>Building and connecting the Pen</h3>\n<p><img src=\"/pen_simple.JPG\" alt=\"pen\"></p>\n<p>The pen is a very simple construction, it is a simple ball point pen with a servo\nhot glued to it. The servo moves the ink chamber and ball point through the barrel\n(<a href=\"https://www.pens.com/blog/parts-of-a-pen/\">yes that's what they are called</a>)\nso the ball point of the pen moves up and down relative to what you are writing on.</p>\n<p>Servo's are very easy to control when utilising the Arduino standard library,\nas previously mention in the blog.\nI got the pen working in code very quickly. I just needed to calibrate the top\nand bottom values for the servo so that it wouldn't rip itself apart.</p>\n<h3>Integrating the heart rate monitor and pen</h3>\n<p>After getting both the heart rate monitor and pen working individually I worked\non making the heart rate impact the pen. This was done with a <code>map</code> function and\nsome variation using the <code>random</code> function. The final commented code can be seen\nbelow.</p>\n<h3>Testing</h3>\n<p>When I finished building and coding the pen I let my roommate try it out. His\nreaction was exactly what I had aimed for in the design. As he used the pen he\nbecame more agitated and frustrated by it's movement, this caused the pen to\nbecome harder to use.</p>\n<video style=\"max-width: 800px; width: auto;\" controls>\n  <source src=\"/tali_pen.MOV\" type=\"video/mp4\">\n</video>\n<p>One problem was that the heart rate sensor often failed or gave strange reasons.\nWhile this is technically a problem it didn't really impact the actual result.\nA bit more variation was probably good as it made the pen even harder to get a handle on.</p>\n<h2>Reflection</h2>\n<p>Overall this project went really well, the class well responded to the justification\nand implementation. Having\nsomeone from the class doing a live demo was also important and very successful.\nAfter the first demonstration someone else in the class even wanted to give it a\ngo!</p>\n<p>The discussion in class was also very interesting. A few points that got brought\nup were:</p>\n<ul>\n<li>Should the feedback loop be switched be negative so it instead calms you down</li>\n<li>Where is the kickstarter?! ðŸ˜†</li>\n<li>If a direct more feedback mechanism was implemented (e.g. vibration)\nyou might be able to control the system better. The current feedback mechanism\nis quite slow and your mind maybe fails to make the intuitive link which would\nallow your body to regulate your heartrate.</li>\n</ul>\n<h2>Appendix</h2>\n<h3>Download: <a href=\"/pen.ino\"><code>pen.ino</code></a></h3>\n<pre><code class=\"hljs language-arduino\"><span class=\"hljs-comment\">/*\n * Adapted from Examples -> Servo -> Sweep &#x26; Examples -> SparkFun MAX3010x Pluse and Proxmity Sensor Library -> Example_5 Plotter\n * All other code my own.\n * \n * \n * Copyright Obi Symons 2021 - Creative Commons Attribution 4.0 International Public License (https://creativecommons.org/licenses/by/4.0/)\n */</span>\n\n<span class=\"hljs-meta\">#<span class=\"hljs-keyword\">include</span> <span class=\"hljs-string\">&#x3C;Servo.h></span></span>\n<span class=\"hljs-meta\">#<span class=\"hljs-keyword\">include</span> <span class=\"hljs-string\">&#x3C;Wire.h></span></span>\n<span class=\"hljs-meta\">#<span class=\"hljs-keyword\">include</span> <span class=\"hljs-string\">\"MAX30105.h\"</span></span>\n<span class=\"hljs-meta\">#<span class=\"hljs-keyword\">include</span> <span class=\"hljs-string\">\"heartRate.h\"</span></span>\n\n<span class=\"hljs-built_in\">Servo</span> myservo;  <span class=\"hljs-comment\">// create servo object to control a servo</span>\n\n<span class=\"hljs-type\">int</span> pos = <span class=\"hljs-number\">0</span>;    <span class=\"hljs-comment\">// Variable to store the servo position</span>\n<span class=\"hljs-type\">int</span> top = <span class=\"hljs-number\">180</span>;  <span class=\"hljs-comment\">// Top and bottom values based for the pen so it doesn't rip itself apart.</span>\n<span class=\"hljs-type\">int</span> bot = <span class=\"hljs-number\">45</span>;\n\n\nMAX30105 particleSensor; <span class=\"hljs-comment\">// Create the sensor object.</span>\n\n\n<span class=\"hljs-function\"><span class=\"hljs-type\">void</span> <span class=\"hljs-title\">setup</span><span class=\"hljs-params\">()</span> </span>{\n  <span class=\"hljs-built_in\">Serial</span>.<span class=\"hljs-built_in\">begin</span>(<span class=\"hljs-number\">115200</span>); \n  <span class=\"hljs-built_in\">Serial</span>.<span class=\"hljs-built_in\">println</span>(<span class=\"hljs-string\">\"Initializing...\"</span>);\n  \n  myservo.<span class=\"hljs-built_in\">attach</span>(<span class=\"hljs-number\">9</span>);  <span class=\"hljs-comment\">// attaches the servo on pin 9 to the servo object</span>\n  myservo.<span class=\"hljs-built_in\">write</span>(bot); <span class=\"hljs-comment\">// Move the servo to the normal writing position</span>\n\n  <span class=\"hljs-comment\">// Initialize sensor</span>\n  <span class=\"hljs-keyword\">if</span> (!particleSensor.<span class=\"hljs-built_in\">begin</span>(<span class=\"hljs-built_in\">Wire</span>, I2C_SPEED_FAST)) <span class=\"hljs-comment\">//Use default I2C port, 400kHz speed</span>\n  {\n    <span class=\"hljs-built_in\">Serial</span>.<span class=\"hljs-built_in\">println</span>(<span class=\"hljs-string\">\"MAX30105 was not found. Please check wiring/power. \"</span>);\n    <span class=\"hljs-keyword\">while</span> (<span class=\"hljs-number\">1</span>);\n  }\n  <span class=\"hljs-built_in\">Serial</span>.<span class=\"hljs-built_in\">println</span>(<span class=\"hljs-string\">\"Place your index finger on the sensor with steady pressure.\"</span>); \n\n  particleSensor.<span class=\"hljs-built_in\">setup</span>(); <span class=\"hljs-comment\">//Configure sensor with default settings</span>\n  particleSensor.<span class=\"hljs-built_in\">setPulseAmplitudeRed</span>(<span class=\"hljs-number\">0x0A</span>); <span class=\"hljs-comment\">//Turn Red LED to low to indicate sensor is running</span>\n  particleSensor.<span class=\"hljs-built_in\">setPulseAmplitudeGreen</span>(<span class=\"hljs-number\">0</span>); <span class=\"hljs-comment\">//Turn off Green LED</span>\n\n  <span class=\"hljs-comment\">// End Initialize sensor</span>\n}\n\n<span class=\"hljs-comment\">// Variables for storing average heartrate</span>\n<span class=\"hljs-type\">const</span> <span class=\"hljs-type\">byte</span> RATE_SIZE = <span class=\"hljs-number\">4</span>; <span class=\"hljs-comment\">//Increase this for more averaging. 4 is good.</span>\n<span class=\"hljs-type\">byte</span> rates[RATE_SIZE]; <span class=\"hljs-comment\">//Array of heart rates</span>\n<span class=\"hljs-type\">byte</span> rateSpot = <span class=\"hljs-number\">0</span>;\n<span class=\"hljs-type\">long</span> lastBeat = <span class=\"hljs-number\">0</span>; <span class=\"hljs-comment\">//Time at which the last beat occurred</span>\n\n<span class=\"hljs-type\">float</span> beatsPerMinute;\n<span class=\"hljs-type\">int</span> beatAvg;\n\n<span class=\"hljs-comment\">// Storing last movement time of the pen.</span>\n<span class=\"hljs-type\">long</span> lastServoChange = <span class=\"hljs-number\">0</span>;\n<span class=\"hljs-type\">int</span> updateInterval = <span class=\"hljs-number\">1000</span>;\n\n<span class=\"hljs-function\"><span class=\"hljs-type\">void</span> <span class=\"hljs-title\">loop</span><span class=\"hljs-params\">()</span> </span>{\n  <span class=\"hljs-comment\">// Get the IR value from the heartbeat sensor.</span>\n  <span class=\"hljs-type\">long</span> irValue = particleSensor.<span class=\"hljs-built_in\">getIR</span>();\n\n  <span class=\"hljs-comment\">// Find a beat (Uses \"heartRate.h\" included with the library)</span>\n  <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-built_in\">checkForBeat</span>(irValue) == <span class=\"hljs-literal\">true</span>)\n  {\n    <span class=\"hljs-comment\">//We sensed a beat!</span>\n    <span class=\"hljs-type\">long</span> delta = <span class=\"hljs-built_in\">millis</span>() - lastBeat;\n    lastBeat = <span class=\"hljs-built_in\">millis</span>();\n\n    <span class=\"hljs-comment\">// Calculate the heartrate and the average</span>\n    beatsPerMinute = <span class=\"hljs-number\">60</span> / (delta / <span class=\"hljs-number\">1000.0</span>);\n\n    <span class=\"hljs-keyword\">if</span> (beatsPerMinute &#x3C; <span class=\"hljs-number\">255</span> &#x26;&#x26; beatsPerMinute > <span class=\"hljs-number\">20</span>)\n    {\n      rates[rateSpot++] = (<span class=\"hljs-type\">byte</span>)beatsPerMinute; <span class=\"hljs-comment\">//Store this reading in the array</span>\n      rateSpot %= RATE_SIZE; <span class=\"hljs-comment\">//Wrap variable</span>\n\n      <span class=\"hljs-comment\">//Take average of readings</span>\n      beatAvg = <span class=\"hljs-number\">0</span>;\n      <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-type\">byte</span> x = <span class=\"hljs-number\">0</span> ; x &#x3C; RATE_SIZE ; x++)\n        beatAvg += rates[x];\n      beatAvg /= RATE_SIZE;\n    }\n  }\n  <span class=\"hljs-comment\">// Change how often we update the pen based on the average heartrate (between 1 and .3 seconds)</span>\n  updateInterval = <span class=\"hljs-built_in\">map</span>(beatAvg, <span class=\"hljs-number\">60</span>, <span class=\"hljs-number\">100</span>, <span class=\"hljs-number\">1000</span>, <span class=\"hljs-number\">300</span>);\n\n  <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-built_in\">millis</span>() - lastServoChange > updateInterval) { <span class=\"hljs-comment\">// Check if we need to update the pen position</span>\n    <span class=\"hljs-type\">int</span> variability = <span class=\"hljs-built_in\">map</span>(beatAvg, <span class=\"hljs-number\">60</span>, <span class=\"hljs-number\">100</span>, bot, top); <span class=\"hljs-comment\">// Map the heart rate to pen positions.</span>\n    pos = <span class=\"hljs-built_in\">random</span>(bot, <span class=\"hljs-built_in\">min</span>(variability, top)); <span class=\"hljs-comment\">// Choice a random position depending on the heartrate</span>\n    myservo.<span class=\"hljs-built_in\">write</span>(pos);\n    lastServoChange = <span class=\"hljs-built_in\">millis</span>(); <span class=\"hljs-comment\">// Reset the time since last change.</span>\n    <span class=\"hljs-built_in\">Serial</span>.<span class=\"hljs-built_in\">print</span>(<span class=\"hljs-string\">\"Avg BPM=\"</span>); <span class=\"hljs-comment\">// print out the Avg BPM for debugging</span>\n    <span class=\"hljs-built_in\">Serial</span>.<span class=\"hljs-built_in\">print</span>(beatAvg);\n\n    <span class=\"hljs-keyword\">if</span> (irValue &#x3C; <span class=\"hljs-number\">50000</span>) <span class=\"hljs-comment\">// Warn the user they don't have the sensor positioned on their finger.</span>\n      <span class=\"hljs-built_in\">Serial</span>.<span class=\"hljs-built_in\">print</span>(<span class=\"hljs-string\">\" No finger?\"</span>);\n\n     <span class=\"hljs-built_in\">Serial</span>.<span class=\"hljs-built_in\">println</span>();\n  }\n}\n</code></pre>"}